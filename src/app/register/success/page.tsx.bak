// src/app/register/success/page.tsx - Updated with real data fetching
'use client'

import { useState, useEffect } from 'react'
import { useSearchParams } from 'next/navigation'
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Skeleton } from '@/components/ui/skeleton'
import { CheckCircle, Clock, Home, Calendar, MapPin, Mail, Phone, CreditCard, Building } from 'lucide-react'

interface RegistrationData {
  id: string
  firstName: string
  lastName: string
  email: string
  isEmsClient: boolean
  status: string
  createdAt: string
  panelInterest?: boolean
  ticketNumber?: string
}

export default function RegistrationSuccessPage() {
  const searchParams = useSearchParams()
  const registrationId = searchParams.get('id')
  
  const [registration, setRegistration] = useState<RegistrationData | null>(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    if (registrationId) {
      fetchRegistration()
    } else {
      setLoading(false)
    }
  }, [registrationId])

  const fetchRegistration = async () => {
    try {
      const response = await fetch(`/api/registrations/${registrationId}`)
      const result = await response.json()
      
      if (result.success) {
        setRegistration({
          id: result.data.id,
          firstName: result.data.firstName,
          lastName: result.data.lastName,
          email: result.data.email,
          isEmsClient: result.data.isEmsClient,
          status: result.data.status,
          createdAt: result.data.createdAt,
          panelInterest: result.data.panelInterests && result.data.panelInterests.length > 0,
          ticketNumber: result.data.ticket?.ticketNumber
        })
      }
    } catch (error) {
      console.error('Error fetching registration:', error)
    } finally {
      setLoading(false)
    }
  }

  if (loading && registrationId) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <Card className="w-full max-w-2xl">
          <CardHeader>
            <Skeleton className="h-8 w-48 mx-auto" />
            <Skeleton className="h-4 w-64 mx-auto" />
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {Array.from({ length: 4 }).map((_, i) => (
                <Skeleton key={i} className="h-16 w-full" />
              ))}
            </div>
          </CardContent>
        </Card>
      </div>
    )
  }

  // Generic success page without specific registration data
  if (!registration) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <Card className="w-full max-w-2xl">
          <CardContent className="pt-6">
            <div className="text-center space-y-6">
              <CheckCircle className="h-20 w-20 text-green-500 mx-auto" />
              <h1 className="text-3xl font-bold text-green-700">Registration Successful!</h1>
              <p className="text-lg text-gray-600">
                Thank you for registering for the EMS Trade Fair Experience.
              </p>
              
              <div className="bg-blue-50 p-6 rounded-lg text-left">
                <h2 className="font-semibold mb-3 text-blue-900">What happens next?</h2>
                <ul className="space-y-2 text-sm text-blue-800">
                  <li className="flex items-start gap-2">
                    <CheckCircle className="h-4 w-4 text-green-500 mt-0.5 flex-shrink-0" />
                    <span>Check your email for confirmation and next steps</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <CheckCircle className="h-4 w-4 text-green-500 mt-0.5 flex-shrink-0" />
                    <span>Your registration will be processed within 24 hours</span>
                  </li>
                  <li className="flex items-start gap-2">
                    <CheckCircle className="h-4 w-4 text-green-500 mt-0.5 flex-shrink-0" />
                    <span>You'll receive your ticket once approved</span>
                  </li>
                </ul>
              </div>

              <div className="flex flex-col sm:flex-row gap-4 justify-center">
                <Link href="/">
                  <Button className="flex items-center gap-2">
                    <Home className="h-4 w-4" />
                    Back to Home
                  </Button>
                </Link>
                <Link href="/ticket-status">
                  <Button variant="outline" className="flex items-center gap-2">
                    <CheckCircle className="h-4 w-4" />
                    Check Status
                  </Button>
                </Link>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    )
  }

  // Specific success page with registration data
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
      <Card className="w-full max-w-2xl">
        <CardHeader>
          <CardTitle className="text-center flex items-center justify-center gap-2">
            <CheckCircle className="h-8 w-8 text-green-500" />
            Registration Successful!
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Status Banner */}
          <div className={`p-4 rounded-lg border ${
            registration.isEmsClient 
              ? 'bg-orange-50 border-orange-200' 
              : 'bg-blue-50 border-blue-200'
          }`}>
            <div className="flex items-center gap-3">
              {registration.isEmsClient ? (
                <Clock className="h-5 w-5 text-orange-600" />
              ) : (
                <CreditCard className="h-5 w-5 text-blue-600" />
              )}
              <div>
                <h3 className={`font-medium ${
                  registration.isEmsClient ? 'text-orange-800' : 'text-blue-800'
                }`}>
                  {registration.isEmsClient 
                    ? 'Pending Admin Approval' 
                    : 'Payment Required'
                  }
                </h3>
                <p className={`text-sm ${
                  registration.isEmsClient ? 'text-orange-700' : 'text-blue-700'
                }`}>
                  {registration.isEmsClient 
                    ? 'Your EMS customer status is being verified by our team'
                    : 'Complete your payment to receive instant access'
                  }
                </p>
              </div>
            </div>
          </div>

          {/* Registration Summary */}
          <div className="p-4 border rounded-lg bg-gray-50">
            <h3 className="font-medium mb-3">Registration Summary</h3>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span>Name:</span>
                <span className="font-medium">{registration.firstName} {registration.lastName}</span>
              </div>
              <div className="flex justify-between">
                <span>Email:</span>
                <span className="font-medium">{registration.email}</span>
              </div>
              <div className="flex justify-between">
                <span>Registration ID:</span>
                <span className="font-mono text-xs">{registration.id}</span>
              </div>
              <div className="flex justify-between">
                <span>Customer Type:</span>
                <span className="font-medium">
                  {registration.isEmsClient ? 'EMS Customer' : 'General Public'}
                </span>
              </div>
              <div className="flex justify-between">
                <span>Status:</span>
                <Badge variant={registration.isEmsClient ? "secondary" : "outline"}>
                  {registration.isEmsClient ? 'Pending Approval' : 'Payment Required'}
                </Badge>
              </div>
              {registration.ticketNumber && (
                <div className="flex justify-between">
                  <span>Ticket Number:</span>
                  <span className="font-mono text-xs">{registration.ticketNumber}</span>
                </div>
              )}
            </div>
          </div>

          {/* Next Steps */}
          <div className="p-4 border rounded-lg bg-green-50">
            <h3 className="font-medium mb-3 flex items-center gap-2">
              <CheckCircle className="h-4 w-4 text-green-600" />
              What Happens Next?
            </h3>
            {registration.isEmsClient ? (
              <div className="space-y-3 text-sm text-green-800">
                <div className="flex items-start gap-2">
                  <div className="w-5 h-5 rounded-full bg-green-200 flex items-center justify-center text-xs font-medium mt-0.5">1</div>
                  <span>Our admin team will verify your EMS customer status (usually within 24 hours)</span>
                </div>
                <div className="flex items-start gap-2">
                  <div className="w-5 h-5 rounded-full bg-green-200 flex items-center justify-center text-xs font-medium mt-0.5">2</div>
                  <span>Once approved, we'll generate your complimentary ticket</span>
                </div>
                <div className="flex items-start gap-2">
                  <div className="w-5 h-5 rounded-full bg-green-200 flex items-center justify-center text-xs font-medium mt-0.5">3</div>
                  <span>You'll receive an email with your ticket and collection instructions</span>
                </div>
                <div className="flex items-start gap-2">
                  <div className="w-5 h-5 rounded-full bg-green-200 flex items-center justify-center text-xs font-medium mt-0.5">4</div>
                  <span>Present your ticket at our booth during the event</span>
                </div>
              </div>
            ) : (
              <div className="space-y-3 text-sm text-green-800">
                <div className="flex items-start gap-2">
                  <div className="w-5 h-5 rounded-full bg-green-200 flex items-center justify-center text-xs font-medium mt-0.5">1</div>
                  <span>Complete your €50 payment to confirm your registration</span>
                </div>
                <div className="flex items-start gap-2">
                  <div className="w-5 h-5 rounded-full bg-green-200 flex items-center justify-center text-xs font-medium mt-0.5">2</div>
                  <span>Your ticket will be generated instantly after payment</span>
                </div>
                <div className="flex items-start gap-2">
                  <div className="w-5 h-5 rounded-full bg-green-200 flex items-center justify-center text-xs font-medium mt-0.5">3</div>
                  <span>You'll receive your ticket via email immediately</span>
                </div>
                <div className="flex items-start gap-2">
                  <div className="w-5 h-5 rounded-full bg-green-200 flex items-center justify-center text-xs font-medium mt-0.5">4</div>
                  <span>Present your ticket for direct access</span>
                </div>
              </div>
            )}
          </div>

          {/* Panel Interest */}
          {registration.panelInterest && (
            <div className="p-4 border rounded-lg bg-purple-50">
              <h3 className="font-medium mb-2 flex items-center gap-2">
                <Building className="h-4 w-4 text-purple-600" />
                Solar Panel Interest Noted
              </h3>
              <p className="text-sm text-purple-800">
                We've noted your interest in EMS solar panels. Our experts will be prepared to discuss 
                your requirements when you visit our booth at the trade fair.
              </p>
            </div>
          )}

          {/* Event Information */}
          <div className="p-4 border rounded-lg bg-blue-50">
            <h3 className="font-medium mb-3 flex items-center gap-2">
              <Calendar className="h-4 w-4 text-blue-600" />
              Event Information
            </h3>
            <div className="space-y-2 text-sm text-blue-800">
              <div className="flex items-center gap-2">
                <Calendar className="h-4 w-4" />
                <span><strong>Dates:</strong> July 26 - August 6, 2025</span>
              </div>
              <div className="flex items-center gap-2">
                <MapPin className="h-4 w-4" />
                <span><strong>Venue:</strong> Malta Fairs and Conventions Centre, Ta' Qali</span>
              </div>
              <div className="flex items-center gap-2">
                <Building className="h-4 w-4" />
                <span><strong>EMS Booth:</strong> MFCC Main Hall</span>
              </div>
            </div>
          </div>

          {/* Contact Information */}
          <div className="p-4 border rounded-lg bg-gray-50">
            <h3 className="font-medium mb-3">Need Help?</h3>
            <div className="space-y-2 text-sm">
              <div className="flex items-center gap-2">
                <Mail className="h-4 w-4 text-gray-600" />
                <span>Email: support@ems-events.com</span>
              </div>
              <div className="flex items-center gap-2">
                <Phone className="h-4 w-4 text-gray-600" />
                <span>Phone: +356 2123 4567</span>
              </div>
            </div>
          </div>

          {/* Action Buttons */}
          <div className="flex flex-col sm:flex-row gap-3">
            {!registration.isEmsClient && registration.status === 'PAYMENT_PENDING' && (
              <Link href={`/payment?id=${registration.id}`} className="flex-1">
                <Button className="w-full">
                  <CreditCard className="mr-2 h-4 w-4" />
                  Complete Payment (€50)
                </Button>
              </Link>
            )}
            <Link href="/" className="flex-1">
              <Button variant="outline" className="w-full">
                <Home className="mr-2 h-4 w-4" />
                Back to Home
              </Button>
            </Link>
            <Link href="/ticket-status" className="flex-1">
              <Button variant="outline" className="w-full">
                <CheckCircle className="mr-2 h-4 w-4" />
                Check Status
              </Button>
            </Link>
          </div>

          <p className="text-xs text-gray-500 text-center">
            Keep this page bookmarked or save your Registration ID: <strong>{registration.id}</strong>
          </p>
        </CardContent>
      </Card>
    </div>
  )
}